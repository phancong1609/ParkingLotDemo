using Project_BaiGiuXe.Sql_Connection; using Project_BaiGiuXe.Tinh_nang_pho_bien; using System; using System.Collections.Generic; using System.Data; using System.Data.SqlClient; using System.Drawing; using System.IO; using System.Linq; using System.Text; using System.Threading.Tasks; using System.Windows.Forms;  namespace Project_BaiGiuXe.Key_User.QL_BaiXe {     internal class Class_Xe     {         //thêm         Class_Connection db = new Class_Connection();          private byte[] ImageToByteArray(Bitmap image)         {             using (MemoryStream ms = new MemoryStream())             {                 image.Save(ms, System.Drawing.Imaging.ImageFormat.Png);                 return ms.ToArray();             }         }         //thêm         public void themXe(string np, Bitmap image, string cardid)         {             SqlCommand cmd = new SqlCommand("INSERT INTO Table_XE (BienSoXe, NgayVaoBai, NgayRaBai) VALUES (@bienso, @ngayvao, @ngayra)", db.getConnection);             cmd.Parameters.AddWithValue("@bienso", np);             cmd.Parameters.AddWithValue("@ngayvao", DateTime.Now);             cmd.Parameters.AddWithValue("@ngayra", DBNull.Value);              SqlCommand cmd2 = new SqlCommand("UPDATE Table_Card SET AnhVao = @anh, BienSoXe = @bienso WHERE MaCard = @cardid ", db.getConnection);             cmd2.Parameters.AddWithValue("@bienso", np);             cmd2.Parameters.AddWithValue("@anh", ImageToByteArray(image));             cmd2.Parameters.AddWithValue("@cardid", cardid);              db.openConnection();             if (cmd.ExecuteNonQuery() > 0)                 TinhNang.ShowThongBao("Thêm xe", "Thêm xe thành công", MessageBoxIcon.Information);             else                 TinhNang.ShowThongBao("Thêm xe", "Thêm xe không thành công", MessageBoxIcon.Error);             db.closeConnection();              db.openConnection();             if (cmd2.ExecuteNonQuery() > 0)                 TinhNang.ShowThongBao("Nhập thẻ", "Nhập thẻ thành công", MessageBoxIcon.Information);             else                 TinhNang.ShowThongBao("Nhập thẻ", "Nhập thẻ không thành công", MessageBoxIcon.Error);             db.closeConnection();         }         //thêm         public void xuatXe(string np, string carid)          {             SqlCommand cmd = new SqlCommand("UPDATE Table_Xe SET NgayRaBai = @ngayra WHERE BienSoXe = @bienso AND NgayRaBai is null", db.getConnection);             cmd.Parameters.AddWithValue("@bienso", np);             cmd.Parameters.AddWithValue("@ngayra", DateTime.Now);              SqlCommand cmd2 = new SqlCommand("UPDATE Table_Card SET AnhVao = null, BienSoXe = null WHERE MaCard = @cardid", db.getConnection);             cmd2.Parameters.AddWithValue("@cardid", carid);              db.openConnection();             if (cmd.ExecuteNonQuery() > 0)                 TinhNang.ShowThongBao("Xuất xe", "Xuất xe thành công", MessageBoxIcon.Information);             else                 TinhNang.ShowThongBao("Xuất xe", "Xuất xe không thành công", MessageBoxIcon.Error);             db.closeConnection();              db.openConnection();             if (cmd2.ExecuteNonQuery() > 0)                 TinhNang.ShowThongBao("Trả thẻ", "Trả thẻ thành công", MessageBoxIcon.Information);             else                 TinhNang.ShowThongBao("Trả thẻ", "Trả thẻ không thành công", MessageBoxIcon.Error);             db.closeConnection();         }         public void themXeVaoBai(TextBox textBox_maSoXe)         {             try             {                 SqlCommand cmd = new SqlCommand("INSERT INTO [dbo].[Table_XE] ([BienSoXe], [NgayVaoBai]) " +                "VALUES (@maSoXe, @ngayVaoBai)", db.getConnection);                 cmd.Parameters.AddWithValue("@maSoXe", textBox_maSoXe.Text);                 cmd.Parameters.Add("@ngayVaoBai", SqlDbType.DateTime).Value = DateTime.Now;                 TinhNang.CUDDuLieu(cmd);             }             catch             {                 TinhNang.ShowThongBao("Nhập xe", "Lỗi nhập xe", MessageBoxIcon.Error);             }         }         public decimal tinhPhiGuiXe(DataTable table, DateTime ngayRaBai)         {             if (table.Rows.Count == 0)             {                 // Không có bản ghi trong DataTable                 return 0;             }              DataRow row = table.Rows[0];             DateTime ngayVaoBai = Convert.ToDateTime(row["NgayVaoBai"]);              // Tính thời gian gửi xe             TimeSpan thoiGianGuiXe = ngayRaBai - ngayVaoBai;              // Tính phí             decimal phi = 1000 * (decimal)thoiGianGuiXe.TotalDays;             return phi;         }      } } 